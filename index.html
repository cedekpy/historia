<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Dokończ Historię Online!</title>
<style>
  body { font-family: Arial; max-width: 800px; margin: auto; padding: 20px; background: #121212; color: #f1f1f1; }
  h1 { color: #f39c12; text-align: center; margin-bottom: 5px; }
  #online { text-align: center; font-size: 0.9em; color: #888; margin-bottom: 15px; }
  #story { border: 2px solid #f39c12; padding: 15px; min-height: 300px; margin-bottom: 15px; background: #1e1e1e; overflow-y: auto; }
  .entry, .announcement-entry { margin-bottom: 8px; padding: 5px; border-bottom: 1px solid #444; cursor: pointer; position: relative; }
  .nick { font-weight: bold; color: #f39c12; }
  .time { font-size: 0.8em; color: #888; margin-left: 5px; }
  input, textarea { width: 100%; padding: 8px; margin-bottom: 10px; font-size: 14px; background: #2a2a2a; border: 1px solid #444; color: #f1f1f1; border-radius: 5px; }
  button { padding: 10px 20px; font-size: 14px; background: #f39c12; color: white; border: none; border-radius: 5px; cursor: pointer; margin-bottom:5px; }
  button:hover { background: #d35400; }
  .deleteBtn { position: absolute; right: 5px; top: 5px; background: #e74c3c; color: white; border: none; border-radius: 3px; padding: 2px 6px; cursor: pointer; }
  .deleteBtn:hover { background: #c0392b; }
  #adminPanel { border: 2px solid #00bfff; padding: 10px; margin-top: 20px; display: none; background: #1a1a1a; }
</style>
</head>
<body>

<h1>Dokończ Historię Online!</h1>
<div id="online">Osób online: 0</div>
<div id="story"></div>

<input type="text" id="nick" placeholder="Twój nick" />
<textarea id="text" placeholder="Napisz ciąg dalszy historii..."></textarea>
<button id="addBtn">Dodaj</button>
<button id="adminBtn">Panel Admina</button>

<div id="adminPanel">
  <h2>Panel Admina</h2>
  <h3>Dodaj ogłoszenie</h3>
  <input type="text" id="annTitle" placeholder="NAZWA">
  <textarea id="annDesc" placeholder="OPIS"></textarea>
  <input type="text" id="annFrom" placeholder="OD">
  <button id="addAnnBtn">Dodaj ogłoszenie</button>
  <button id="clearAllBtn">Usuń całą historię</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
  // Konfiguracja Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCIwYErwoseOBOjaEo6ZGaxqhDoOOUbBk8",
    authDomain: "historia-af8be.firebaseapp.com",
    databaseURL: "https://historia-af8be-default-rtdb.firebaseio.com",
    projectId: "historia-af8be",
    storageBucket: "historia-af8be.firebasestorage.app",
    messagingSenderId: "528830401274",
    appId: "1:528830401274:web:c07897792c165020d81743",
    measurementId: "G-DHJTCQKT90"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const storyDiv = document.getElementById('story');
  const addBtn = document.getElementById('addBtn');
  const nickInput = document.getElementById('nick');
  const textInput = document.getElementById('text');
  const adminBtn = document.getElementById('adminBtn');
  const adminPanel = document.getElementById('adminPanel');
  const clearAllBtn = document.getElementById('clearAllBtn');
  const addAnnBtn = document.getElementById('addAnnBtn');
  const annTitle = document.getElementById('annTitle');
  const annDesc = document.getElementById('annDesc');
  const annFrom = document.getElementById('annFrom');
  const onlineDiv = document.getElementById('online');

  let isAdmin = false; // zmienna kontrolująca dostęp do usuwania

  // Dodawanie wpisu
  addBtn.addEventListener('click', () => {
    const nick = nickInput.value.trim();
    const text = textInput.value.trim();
    if (!nick || !text) { alert('Podaj nick i tekst!'); return; }

    const now = new Date();
    const timeString = now.toLocaleString('pl-PL', { dateStyle: 'short', timeStyle: 'short' });
    db.ref('story').push({ nick, text, time: timeString });
    textInput.value = '';
  });

  // Wyświetlanie historii i ogłoszeń
  function addEntryToDiv(key, data, isAnnouncement=false){
    const div = document.createElement('div');
    div.classList.add(isAnnouncement ? 'announcement-entry' : 'entry');
    if(isAnnouncement){
      div.innerHTML = `<strong>${data.title}</strong> [${data.from}]: ${data.desc}`;
    } else {
      div.innerHTML = `<span class="nick">${data.nick}</span> <span class="time">[${data.time}]</span>: ${data.text}`;
    }

    // Powiększenie po kliknięciu
    div.addEventListener('click', () => {
      if(isAnnouncement){
        alert(`${data.title} [${data.from}]:\n\n${data.desc}`);
      } else {
        alert(`${data.nick} [${data.time}]:\n\n${data.text}`);
      }
    });

    // Przyciski usuwania tylko jeśli jesteś adminem
    if(isAdmin){
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = "Usuń";
      deleteBtn.classList.add('deleteBtn');
      deleteBtn.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(confirm('Na pewno usunąć?')){
          const refPath = isAnnouncement ? 'announcements/' + key : 'story/' + key;
          db.ref(refPath).remove();
        }
      });
      div.appendChild(deleteBtn);
    }

    storyDiv.appendChild(div);
    storyDiv.scrollTop = storyDiv.scrollHeight;
  }

  function renderHistory(){
    storyDiv.innerHTML = '';
    db.ref('story').once('value', snap => snap.forEach(s => addEntryToDiv(s.key, s.val(), false)));
    db.ref('announcements').once('value', snap => snap.forEach(s => addEntryToDiv(s.key, s.val(), true)));
  }

  db.ref('story').on('child_added', snap => addEntryToDiv(snap.key, snap.val(), false));
  db.ref('announcements').on('child_added', snap => addEntryToDiv(snap.key, snap.val(), true));
  db.ref('story').on('child_removed', renderHistory);
  db.ref('announcements').on('child_removed', renderHistory);

  // Licznik osób online
  const onlineRef = db.ref('online');
  const userRef = onlineRef.push(true);
  userRef.onDisconnect().remove();
  onlineRef.on('value', snapshot => {
    onlineDiv.textContent = `Osób online: ${snapshot.numChildren()}`;
  });

  // Panel admina
  adminBtn.addEventListener('click', ()=>{
    const pass = prompt("Podaj hasło admina:");
    if(pass === "cedekpaneladm"){
      isAdmin = true;
      adminPanel.style.display="block";
      alert("Panel aktywowany!");
      renderHistory(); // odśwież, aby przyciski Usuń się pojawiły
    } else alert("Nieprawidłowe hasło!");
  });

  // Usuń całą historię
  clearAllBtn.addEventListener('click', ()=>{
    if(confirm('Na pewno usunąć całą historię?')){
      db.ref('story').remove();
      db.ref('announcements').remove();
    }
  });

  // Dodawanie ogłoszenia
  addAnnBtn.addEventListener('click', ()=>{
    const title = annTitle.value.trim();
    const desc = annDesc.value.trim();
    const from = annFrom.value.trim();
    if(!title || !desc || !from){ alert("Wypełnij wszystkie pola!"); return; }
    db.ref('announcements').push({ title, desc, from });
    annTitle.value = ''; annDesc.value = ''; annFrom.value = '';
  });
</script>
</body>
</html>
